<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFT練習</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
  <script src="./abi.js"></script>
</head>
<body>
  <h1>NFT Minting Example</h1>
  <button id="loadWallet">MetaMaskをロード</button>
  <form id="mintForm" style="display: none">
    <label for="tokenId">Token ID:</label>
    <input type="number" id="tokenId" name="tokenId" min="1" required />
    <label for="assetName">アセット名:</label>
    <input type="text" id="assetName" name="assetName" required />
    <button type="submit">NFTをmintする</button>
  </form>
  <p id="mintStatus"></p>

  <script>
    const CONTRACT_ADDRESS = "0x3455E67b1a679A898bE68f78bE85532cF6512052"; // Sepolia
    let provider, signer, nftContract;
    let userAddress = localStorage.getItem("userAddress");

    async function authenticate() {
      if (window.ethereum) {
        try {
          const accounts = await ethereum.request({ method: "eth_accounts" });
          console.log("MetaMaskアカウント情報:", accounts);
          if (accounts.length === 0) {
            await ethereum.request({ method: "eth_requestAccounts" });
          }
          userAddress = accounts[0];
          localStorage.setItem("userAddress", userAddress); // Store the address in localStorage
        } catch (error) {
          console.error("認証エラー:", error);
        }
      } else {
        console.error("MetaMaskがインストールされていません");
      }
    }

    const loadWalletButton = document.getElementById("loadWallet");
    const mintForm = document.getElementById("mintForm");
    const mintStatus = document.getElementById("mintStatus");

    loadWalletButton.addEventListener("click", async () => {
      await authenticate(); // Call authenticate function to get user address
      if (userAddress) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        nftContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        mintForm.style.display = "block";
      } else {
        alert("ユーザーアドレスが取得できませんでした。再度ログインしてください。");
      }
    });

    mintForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const tokenId = document.getElementById("tokenId").value;
      const assetName = document.getElementById("assetName").value;

      if (nftContract && userAddress && tokenId && assetName) {
        try {
          const tx = await nftContract.safeMint(userAddress, tokenId, assetName);
          mintStatus.innerText = "トランザクション送信中: トランザクションハッシュ: " + tx.hash;
          await tx.wait();
          mintStatus.innerText = "成功: トランザクションハッシュ: " + tx.hash;
        } catch (error) {
          console.error(error);
          mintStatus.innerText = "失敗: " + error.message;
        }
      }
    });
  </script>
</body>
</html>
